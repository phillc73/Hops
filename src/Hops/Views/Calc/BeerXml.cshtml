@using Hops.Models;
@model HopModel

@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    ViewBag.Title = "BeerXML Viewer - Hops";
}

@section Scripts {
    <script src="~/lib/brauhaus/lib/brauhaus.min.js"></script>
    <script src="~/brauhaus/brauhaus-beerxml-brewtoad.js"></script>
}

<div class="card">
    <div class="card-header">BeerXML Viewer</div>
    <div class="card-body">
        <p>Please select your recipe:</p>

        <div class="form-group">
            <label class="btn btn-primary d-print-none" for="my-file-selector">
                <input id="my-file-selector" accept="text/xml" type="file" style="display: none;" onchange="readURL(this);">
                <span class="fas file-upload" aria-hidden="true"></span> Browse...
            </label>
        </div>

        <script>
            function readURL(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        var recipe = Brauhaus.Recipe.fromBeerXml(e.target.result)[0];
                        recipe.ibuMethod = "rager";
                        recipe.calculate();

                        $("#name").text(recipe.name);

                        $("#style").text("a " + recipe.type + " " + recipe.style.name + " by " + recipe.author);

                        $("#stats").empty();
                        $("#stats").append("<tr><td style='width:6%;'>OG</td>     <td style='width:6%;'><strong>" + recipe.og.toFixed(3) + "</strong></td><td width='88%'>" + createBar(recipe.og, 1.000, 1.150, recipe.style.og[0], recipe.style.og[1]) + "</td></tr>");
                        $("#stats").append("<tr><td style='width:6%;'>FG</td>     <td style='width:6%;'><strong>" + recipe.fg.toFixed(3) + "</strong></td><td width='88%'>" + createBar(recipe.fg, 1.000, 1.150, recipe.style.fg[0], recipe.style.fg[1]) + "</td></tr>");
                        $("#stats").append("<tr><td style='width:6%;'>IBU</td>    <td style='width:6%;'><strong>" + recipe.ibu.toFixed(0) + "</strong></td><td width='88%'>" + createBar(recipe.ibu, 0, 120, recipe.style.ibu[0], recipe.style.ibu[1]) + "</td></tr>");
                        $("#stats").append("<tr><td style='width:6%;'>SRM</td>    <td style='width:6%;'><strong>" + recipe.color.toFixed(0) + "</strong></td><td width='88%'>" + createBar(recipe.color, 0, 40, recipe.style.color[0], recipe.style.color[1]) + "</td></tr>");
                        $("#stats").append("<tr><td style='width:6%;'>ABV</td>    <td style='width:6%;'><strong>" + recipe.abv.toFixed(1) + "%</strong></td><td width='88%'>" + createBar(recipe.abv, 1, 14, recipe.style.abv[0], recipe.style.abv[1]) + "</td></tr>");

                        recipe.ibuMethod = "tinseth";
                        recipe.calculate();

                        $("#stats").append("<tr><td style='width:6%;'>Balance</td><td style='width:6%;'><strong>" + recipe.bv.toFixed(2) + "</strong></td><td width='88%'>" + createBar(recipe.bv, 0, 1, calcBugu(recipe.style.og[0], recipe.style.ibu[0]), calcBugu(recipe.style.og[0], recipe.style.ibu[1])) + "</td></tr>");
                        $("#stats").append("<tr><td style='width:6%;'></td><td style='width:6%;'></td><td style='width:88%;'><h5><small>" + (isConform(recipe) ? "<span class='fas fa-check' aria-hidden='true'></span> " : "") + "Recipe " + (isConform(recipe) ? "conforms" : "does not conform") + " to the <strong>" + recipe.style.name + "</strong> style.</small><h5> </td></tr>");

                        $("#fermentables").empty();
                        $.each(recipe.fermentables, function (index, fermentable) {
                            $("#fermentables").append("<tr>" +
                                "<td>" + (fermentable.weight * 1000) + " g</td>" +
                                "<td><span style='display: inline-block; width: 12px; height: 12px; background-color: " + fermentable.colorCss() + "'></span> " + fermentable.name + "</td>" +
                                "<td>" + fermentable.addition().substring(0, 1).toUpperCase() + fermentable.addition().substring(1, fermentable.addition().length) + "</td>" +
                                "<td>" + Math.ceil(fermentable.ppg()) + "</td>" +
                                "<td>" + fermentable.color + " &deg;L</td></tr>");
                        });

                        $("#hops").empty();
                        $("#extras").empty();
                        $("#extrasTable").hide();
                        $.each(recipe.spices, function (index, spice) {
                            if (spice.aa !== 0) {
                                $("#hops").append("<tr>" +
                                    "<td>" + (spice.weight * 1000) + " g</td>" +
                                    "<td>" + spice.name + "</td>" +
                                    "<td>" + Brauhaus.displayDuration(spice.time) + "</td>" +
                                    "<td>" + spice.use + "</td>" +
                                    "<td>" + spice.form + "</td>" +
                                    "<td>" + spice.aa.toFixed(1) + "%</td>" +
                                    "</tr>");
                            } else {
                                $("#extras").append("<tr>" +
                                    "<td>" + spice.weight + (spice.amountIsWeight ? " g" : " each") + "</td>" +
                                    "<td>" + spice.name + "</td>" +
                                    "<td>" + Brauhaus.displayDuration(spice.time) + "</td>" +
                                    "<td>" + spice.use + "</td>" +
                                    "</tr>");
                                $("#extrasTable").show();
                            }
                        });

                        $("#yeasts").empty();
                        $.each(recipe.yeast, function (index, yeast) {
                            $("#yeasts").append("<tr><td>" + yeast.name + "</td><td>" + yeast.laboratory + "</td><td>" + yeast.attenuation + "%</td></tr>");
                        });

                        $("#moreStats").empty();
                        $("#moreStats").append("<tr><td>Batch size</td><td><strong>" + recipe.batchSize + " L</strong></td></tr>");
                        $("#moreStats").append("<tr><td>Boil time</td><td><strong>" + recipe.boilTime + " min</strong></td></tr>");

                        $("#printStats").empty();
                        $("#printStats").append("<tr><td>OG</td><td><strong>" + recipe.og.toFixed(3) + "</strong></td></tr>");
                        $("#printStats").append("<tr><td>FG</td><td><strong>" + recipe.fg.toFixed(3) + "</strong></td></tr>");
                        $("#printStats").append("<tr><td>IBU</td><td><strong>" + recipe.ibu.toFixed(0) + "</strong></td></tr>");
                        $("#printStats").append("<tr><td>ABV</td><td><strong>" + recipe.abv.toFixed(1) + "%</strong></td></tr>");
                        $("#printStats").append("<tr><td>Color</td><td><strong><span style='display: inline-block; width: 12px; height: 12px; background-color: " + Brauhaus.srmToCss(recipe.color) + "'></span> " + recipe.color.toFixed(0) + " SRM</strong></td></tr>");
                        $("#printStats").append("<tr><td>Balance</td><td><strong>" + recipe.bv.toFixed(2) + "</strong></td></tr>");

                        $('#preview').show();
                    };
                    reader.readAsText(input.files[0]);
                }
            }

            function createBar(value, scaleStart, scaleEnd, lowerBound, upperBound) {
                var barStart = ((lowerBound - scaleStart) / (scaleEnd - scaleStart)) * 100;
                var barEnd = ((upperBound - scaleStart) / (scaleEnd - scaleStart)) * 100;
                var valueMarker = ((value - scaleStart) / (scaleEnd - scaleStart)) * 100;

                var bar = "";
                bar += "<div class='progress' style='margin: 0px 0px 5px 0px;'>";
                bar += "<div class='progress-bar' role='progressbar' style='background-color: #f5f5f5; background-image: linear-gradient(to bottom,#ebebeb 0,#f5f5f5 100%); box-shadow: inset 0 1px 2px rgba(0,0,0,.1); width: " + barStart + "%'><span class='sr-only'>bla</span></div>";
                bar += "<div class='progress-bar' role='progressbar' style='background-image: linear-gradient(to bottom,#b55002 0,#b55002 100%); opacity: 0.2; width: " + (barEnd - barStart) + "%'><span class='sr-only'>bla</span></div>";
                bar += "<div style='width: 3px; height: 20px; position: relative; background: #ce5b02; left: " + valueMarker + "%;'></div>";
                bar += "</div>";
                return bar;
            }

            function calcBugu(og, ibu) {
                var bugu = ibu / ((og - 1) * 1000);
                if (isNaN(bugu) || bugu < 0) bugu = 0;
                if (bugu > 1) bugu = 1;
                return bugu;
            }

            function calcBv(og, fg, ibu, isUpper) {
                var rte = (0.82 * (fg - 1.000) + 0.18 * (og - 1.000)) * 1000.0;
                var bv = 0.8 * ibu / rte;
                if (isNaN(bv) || bv < 0) bv = isUpper ? 1 : 0;
                if (bv > 1) bv = 1;
                return bv;
            }

            function isConform(recipe) {
                var result = true;
                result = result && (recipe.og >= recipe.style.og[0] && recipe.og <= recipe.style.og[1]);
                result = result && (recipe.fg >= recipe.style.fg[0] && recipe.fg <= recipe.style.fg[1]);
                result = result && (recipe.ibu >= recipe.style.ibu[0] && recipe.ibu <= recipe.style.ibu[1]);
                result = result && (recipe.color >= recipe.style.color[0] && recipe.color <= recipe.style.color[1]);
                result = result && (recipe.abv >= recipe.style.abv[0] && recipe.abv <= recipe.style.abv[1]);
                return result;
            }
        </script>
    </div>
</div>

<div id="preview" style="display: none">

    <div class="card">
        <div class="card-body">
            <button type="button" class="btn btn-default pull-right hidden-print" onclick="window.print();">
                <span class="fas fa-print" aria-hidden="true"></span> Print...
            </button>

            <h2 id="name" style="margin-top: 0;">Name</h2>

            <h6 id="style">Style</h6>

            <table id="stats" class="table hidden-print"></table>

            <h2>Fermentables</h2>
            <table class="table">
                <tr><th>Amount</th><th>Fermentable</th><th>Use</th><th>PPG</th><th>Color</th></tr>
                <tbody id="fermentables"></tbody>
            </table>

            <h2>Hops</h2>
            <table class="table">
                <tr><th>Amount</th><th>Hop</th><th>Time</th><th>Use</th><th>Form</th><th>AA</th></tr>
                <tbody id="hops"></tbody>
            </table>

            <h2>Yeast</h2>
            <table class="table">
                <tr><th>Name</th><th>Lab/Product</th><th>Attenuation</th></tr>
                <tbody id="yeasts"></tbody>
            </table>

            <div id="extrasTable" style="display: none">
                <h2>Extras</h2>
                <table class="table">
                    <tr><th>Amount</th><th>Name</th><th>Time</th><th>Use</th></tr>
                    <tbody id="extras"></tbody>
                </table>
            </div>

            <h2>Stats</h2>
            <table id="moreStats" class="table"></table>

            <table id="printStats" class="table visible-print-block"></table>
        </div>
    </div>

</div>